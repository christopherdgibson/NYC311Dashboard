@inject IRequestService RequestService
@inject IChartService ChartService
@inject ILayoutService LayoutService
@inject IMessagingService MessagingService

@page "/requestsbyzip"

@using CSharpFunctionalExtensions
@using NYC311Dashboard.Components
@using NYC311Dashboard.Models
@using NYC311Dashboard.Services
@using NYC311Dashboard.Services.Contracts
@using NYC311Dashboard.Extensions
@using NYC311Dashboard.Services.Models

@if (ShowChart)
{
    <div class="content-block">
        <h2>Chart: Requests per hour by selected boroughs</h2>
        <div id="chart" class="apex-chart-flex-container"></div>

        <h2>Table: Requests per hour for selected zip codes</h2>
        <div class="table-flex-container">
            <SortableTable Items="requestsByZipHour" Options=@GetTableOptions() />
        </div>
    </div>
}

@code {
    private List<RequestModel> requests = new List<RequestModel>();
    private List<ZipHourTableRow> requestsByZipHour = new List<ZipHourTableRow>();
    private List<string> boroughs = new();
    private List<string> zipCodes = new();
    private HashSet<string> selectedBoroughs = new();
    private HashSet<string> selectedZipCodes = new();
    private string label = "Select Zip Codes";
    private string message = "Please refresh data to populate boroughs list!";

    private bool chartNeedsRefresh = false;
    private bool ShowChart => requestsByZipHour != null && requestsByZipHour.Count != 0 && selectedZipCodes.Any();

    protected override void OnInitialized()
    {
        LayoutService.SetTitle("Requests by Zip Code");
    }

    protected override async Task OnInitializedAsync()
    {
        if (RequestService.Boroughs.Count == 0) // selected boroughs check necessary for checkbox null error. Always the case?
        {
            LayoutService.SetSidebar(
                LayoutService.RenderInactiveSidebarButton("No data available", message)
        );
            return;
        }

        if (RequestService.SelectedBoroughs.Count == 0) // selected boroughs check necessary for checkbox null error. Always the case?
        {
            LayoutService.SetSidebar(
                LayoutService.RenderInactiveSidebarButton("No data available", "No boroughs selected! Please select one or more boroughs to see zip code data.")
        );
            return;
        }

        await RefreshRequestsByZipHour();


        // if (RequestService.RequestsByZipHour.Count == 0) // would need to also condition on borough selection changed to keep this but maybe not worth it
        // {
        //     await RefreshRequestsByZipHour();
        // }
        // else
        // {
        //     requestsByZipHour = RequestService.RequestsByZipHour;
        // }

        requests = RequestService.Requests;
        boroughs = RequestService.Boroughs;
        zipCodes = RequestService.ZipCodes;
        selectedBoroughs = RequestService.SelectedBoroughs;
        selectedZipCodes = RequestService.SelectedZipCodes;

        LayoutService.SetSidebar(LayoutService.RenderCustomSidebar(
             label,
             zipCodes,
             selectedZipCodes,
             EventCallback.Factory.Create<HashSet<string>>(this, v => selectedZipCodes = v),
             OnZipSelectionChanged
         ));

        chartNeedsRefresh = ShowChart;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!chartNeedsRefresh)
        {
            return;
        }

        chartNeedsRefresh = false;
        await ChartService.RenderLineChart("#chart");
    }

    private async Task OnZipSelectionChanged()
    {
        await RefreshRequestsByZipHour();
        chartNeedsRefresh = ShowChart;
    }

    protected async Task RefreshRequestsByZipHour()
    {
        requestsByZipHour.Clear();

        var result = RequestService.GenerateTableByZipHour();
        if (result.IsFailure)
        {
            return;
        }

        requestsByZipHour = RequestService.RequestsByZipHour;
    }

    protected TableOptions<ZipHourTableRow> GetTableOptions()
    {
        var options = new TableOptions<ZipHourTableRow>
            {
                GroupBy = r => r.Borough,
                TableStyles = "table-flex-item"
            };

            return options;
    }

    public async ValueTask DisposeAsync()
    {
        await ChartService.DisposeApexChart();
    }
}