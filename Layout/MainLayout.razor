@using Constants
@using NYC311Dashboard.Components
@using NYC311Dashboard.Services.Contracts
@inherits LayoutComponentBase
@inject ILayoutService LayoutService
@inject NavigationManager Navigation


<div class="">
    <div class="sidebar">
        <div class="sidebar-header">
            <img src="images/NYC_311_logo.png" alt="Logo" class="sidebar-logo" />
        </div>
        <div class="sidebar-body">
            <div class="sidebar-swap-container">
                @if (LayoutService.CustomSidebar != null)
                {
                    @LayoutService.CustomSidebar
                }
            </div>
            <button class="sidebar-btn scroll-to-top-btn" @onclick="LayoutService.ScrollToTop">
                <i class="bi bi-arrow-up-circle-fill"></i>
                <span>Top</span>
            </button>
            <button class="nav-expand-menu" @onclick='() => LayoutService.ToggleNavbar()'>
                <svg width="40"
                     height="40"
                     xmlns="http://www.w3.org/2000/svg"
                     viewbox="0 -50 448 512">
                    <path fill="currentColor"
                          d="M0 96C0 78.3 14.3 64 32 64l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 128C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32l384 0c17.7 0 32 14.3 32 32s-14.3 32-32 32L32 288c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32L32 448c-17.7 0-32-14.3-32-32s14.3-32 32-32l384 0c17.7 0 32 14.3 32 32z" />
                </svg>
            </button>
        </div>
    </div>

    <main>
        <NavbarCustom />
        <GlobalLoadingOverlay />
        <article class="content">
            @if (!string.IsNullOrEmpty(LayoutService.Title))
            {
                <h1>@LayoutService.Title</h1>
            }
            @if (Navigation.ToBaseRelativePath(Navigation.Uri) != "")
            {
                <ErrorBlock />
            }
            @Body
            <button class="scroll-to-top-mobile-btn icon-btn" @onclick="LayoutService.ScrollToTop">
                <i class="bi bi-arrow-up-circle-fill"></i>
            </button>
        </article>
    </main>
</div>

@code {
    [CascadingParameter(Name = "CustomSidebar")]
    public RenderFragment? CustomSidebar { get; set; }

    protected override void OnInitialized()
    {
        LayoutService.OnSidebarChanged += StateHasChanged;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LayoutService.CloseNavOnClick("nav ul", "nav-open");
        }
    }

    public void Dispose()
    {
        LayoutService.OnSidebarChanged -= StateHasChanged;
    }

    public async Task MainLayoutStateUpdate()
    {
        StateHasChanged();        
    }
}