using CSharpFunctionalExtensions;
using Microsoft.Extensions.Options;
using Microsoft.JSInterop;
using NYC311Dashboard.Extensions;
using NYC311Dashboard.Pages;
using NYC311Dashboard.Services.Contracts;
using NYC311Dashboard.Services.Models;

namespace NYC311Dashboard.Services
{
    public class ChartService : IChartService
    {
        private readonly IJSRuntime _js;
        private readonly IRequestService _requestService;
        private readonly ILoadingService _loadingService;
        private readonly IMessagingService _messagingService;
        public ChartOptions? BarChartByBorough { get; private set; }
        public ChartOptions? LineChartByZipHour { get; private set; }

        public ChartService(IJSRuntime js, IRequestService requestService, ILoadingService loadingService, IMessagingService messagingService)
        {
            _js = js;
            _requestService = requestService;
            _loadingService = loadingService;
            _messagingService = messagingService;
        }

        public async Task RenderBarChart(string elementSelector, ChartOptions? options = null)
        {
            try
            {
                _loadingService.LoadingMessage = "I'm loading here!";
                _loadingService.IsLoading = true;

                if (options == null)
                {
                    var categories = _requestService.SelectedBoroughs.ToList();

                    var totalDurations = _requestService.SelectedBoroughs
                        .Select(b => _requestService.RequestsByBoroughDate.Where(r => r.Borough.Equals(b, StringComparison.OrdinalIgnoreCase)).Sum(r => r.OpenTime))
                        .ToList();

                    var totalCounts = _requestService.SelectedBoroughs
                        .Select(b => (double)_requestService.Requests.Count(r => r.Borough.Equals(b, StringComparison.OrdinalIgnoreCase)))
                        .ToList();

                    var series = new List<ApexSeries>
                    {
                        new ApexSeries { Name = "Total Count", Data = totalCounts },
                        new ApexSeries { Name = "Total Duration", Data = totalDurations }
                    };

                    var result = GetChartOptions("boroughs", categories, series, height: "380");

                    options = result.IsSuccess ? result.Value : BarChartByBorough;
                }

                BarChartByBorough = options;

                var error = await _js.InvokeAsync<string?>("renderApexBarChart", elementSelector, options);
                if (error != null)
                {
                    _messagingService.ShowError(error);
                }

            }
            catch
            {
                _messagingService.ShowError("Failed to render chart. Please check your connection and try again."); //todo: dialog box with error message and retry button?
            }
            finally
            {
                _loadingService.IsLoading = false;
            }
        }

        public async Task RenderLineChart(string elementSelector, ChartOptions? options = null)
        {
            try
            {
                _loadingService.LoadingMessage = "I'm loading here!";
                _loadingService.IsLoading = true;

                if (options == null)
                {
                    var categories = _requestService.RequestsByZipHour
                    .Select(r => r.CreatedDate.ToDateTimeHour())
                    .Distinct()
                    .OrderBy(x => x)
                    .ToList();

                    var series = _requestService.SelectedBoroughs
                        .Where(borough => _requestService.RequestsByZipHour.Any(r => r.Borough.Equals(borough, StringComparison.OrdinalIgnoreCase) && _requestService.SelectedZipCodes.Contains(r.Zip)))
                        .Select(borough => new ApexSeries
                        {
                            Name = borough,
                            Data = categories.Select(cat =>
                                _requestService.RequestsByZipHour
                                    .Where(r => r.Borough.Equals(borough, StringComparison.OrdinalIgnoreCase) && _requestService.SelectedZipCodes.Contains(r.Zip) && r.CreatedDate.ToDateTimeHour() == cat)
                                    .Sum(r => r.OpenTime)
                            ).ToList()
                        })
                        .ToList();

                    var result = GetChartOptions("zip codes", categories, series, height: "380");

                    options = result.IsSuccess ? result.Value : LineChartByZipHour;
                }

                LineChartByZipHour = options;

                var error = await _js.InvokeAsync<string?>("renderApexChartMulti", elementSelector, options);
                if (error != null)
                {
                    _messagingService.ShowError(error);
                }
            }
            catch
            {
                _messagingService.ShowError("Failed to render chart. Please check your connection and try again.");
            }
            finally
            {
                _loadingService.IsLoading = false;
            }
        }

        public async Task UpdateApexChart(ChartOptions options)
        {
            await _js.InvokeVoidAsync("updateApexChart", options);
        }

        public Result<ChartOptions> GetChartOptions(string selection, List<string> categories, List<ApexSeries> series, string? width = null, string? height = null)
        {
            try
            {
                _loadingService.LoadingMessage = "I'm loading here!";
                _loadingService.IsLoading = true;
                string type;
                if (selection == "boroughs")
                {
                    type = "bar";
                }
                else
                {
                    type = "line";
                }

                if (!categories.Any())
                {
                    _messagingService.ShowInfo($"No {selection} selected!");
                    _loadingService.IsLoading = false;
                    return Result.Failure<ChartOptions>("No boroughs selected!");
                }

                categories.Sort();
                var options = new ChartOptions
                {
                    Chart = new Chart { Type = type },
                    XAxis = new XAxis { Categories = categories },
                    Series = series.OrderBy(r => r.Name).ToList(),
                    Width = width,
                    Height = height
                };

                if (type == "bar")
                {
                    BarChartByBorough = options;
                }
                if (type == "line")
                {
                    LineChartByZipHour = options;
                }

                _messagingService.Clear();
                return Result.Success(options);
            }
            catch
            {
                _messagingService.ShowError("Failed to get chart options.");
                return Result.Failure<ChartOptions>("Failed to get chart options.");
            }
            finally
            {
                _loadingService.IsLoading = false;
            }
        }

        public async Task DisposeApexChart()
        {
            await _js.InvokeVoidAsync("disposeApexChart");
        }
    }
}
